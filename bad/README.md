# Лабораторная работа 5: Рефакторинг и оптимизация базы данных

## Описание

Этот проект создан специально для изучения принципов оптимизации SQL-запросов и работы с индексами в базах данных. Проект содержит ряд намеренно неоптимизированных запросов, которые вам предстоит проанализировать и улучшить.

## Структура проекта

- `config.js` - Конфигурация подключения к базе данных
- `db.js` - Модуль для работы с базой данных
- `schema.sql` - SQL-схема базы данных (без индексов)
- `seed.js` - Скрипт для заполнения базы данных тестовыми данными
- `index.js` - Основной файл приложения с неоптимизированными запросами
- `test-performance.js` - Скрипт для тестирования производительности запросов

## Установка и настройка

1. Установите зависимости:
   ```
   npm install
   ```

2. Создайте базу данных в PostgreSQL:
   ```
   createdb optimization_lab
   ```

3. При необходимости отредактируйте настройки подключения к базе данных в файле `config.js`.

4. Заполните базу данных тестовыми данными:
   ```
   npm run seed
   ```

5. Запустите приложение:
   ```
   npm start
   ```

## Задания для оптимизации

В проекте имеются следующие неоптимизированные запросы, которые нужно проанализировать и улучшить:

1. Выборка всех клиентов без пагинации (`/customers`)
2. Поиск клиентов по email без индекса (`/customers/search`)
3. Запрос с множественными JOIN без индексов (`/orders/details`)
4. Использование подзапросов вместо JOIN (`/products/with-orders`)
5. Использование WHERE IN с подзапросом (`/customers/with-orders`)
6. Сортировка без индекса (`/orders/recent`)
7. Использование OR-условий без индексов (`/products/search`)
8. GROUP BY без индекса (`/sales/by-category`)
9. DISTINCT без индекса (`/unique-customers`)

## Измерение производительности

Для тестирования производительности запросов используйте скрипт `test-performance.js`:

```
node test-performance.js
```

Скрипт выполнит все неоптимизированные запросы, покажет план выполнения (EXPLAIN ANALYZE) и измерит время выполнения.

## Задачи

1. Проведите анализ производительности существующих запросов с помощью `test-performance.js`.
2. Оптимизируйте запросы в файле `index.js`.
3. Создайте файл `optimized-schema.sql` с оптимизированной схемой (добавленными индексами).
4. Создайте файл для сравнения производительности до и после оптимизации.
5. Подготовьте отчет с описанием внесенных изменений и их влияния на производительность.

## Советы

- Используйте `EXPLAIN ANALYZE` для анализа выполнения запросов.
- Обратите внимание на столбцы, по которым часто выполняется фильтрация (WHERE) или соединение (JOIN).
- Не добавляйте индексы бездумно - каждый индекс увеличивает время операций INSERT, UPDATE и DELETE.
- Рассмотрите возможность добавления составных индексов для комплексных запросов.
- Не забывайте о влиянии условий LIKE с шаблоном, начинающимся с `%` на эффективность индексов. 